# 系统设计原理总结

## 整体架构

这是一个**语音交互的书籍搜索与投影显示系统**，主要包含三个核心模块：

```
语音输入 → 文本识别 → 书籍搜索 → 位置定位 → 投影高亮显示
```

## 核心模块

### 1. 语音识别模块 (`voice_recognition.py`)

**原理：**
- 使用 Google Speech Recognition API 将语音转换为文本
- 通过 PyAudio 捕获麦克风音频
- 支持中英文识别（当前设置为英文）

**工作流程：**
```
麦克风录音 → 音频预处理 → Google API识别 → 返回文本
```

**特点：**
- 自动校准环境噪音
- 支持持续监听模式
- 失败时降级到系统 say 命令

### 2. 书籍数据库模块 (`book_database.py`)

**原理：**
- 存储每本书的**归一化坐标**（0-1之间）
- 坐标表示书籍在照片中的位置和大小
- 使用模糊匹配算法搜索书籍

**数据结构：**
```python
{
    "book_key": {
        "position": (x, y, width, height),  # 归一化坐标
        "shelf": 0,  # 0=上排, 1=下排
        "full_name": "完整书名"
    }
}
```

**搜索算法（改进版）：**
1. 精确匹配（最高优先级）
2. 移除干扰词（the, a, find等）
3. 多词匹配（至少2个词匹配）
4. 关键词匹配（避免误匹配）

### 3. 投影显示模块

#### 3.1 简单模式 (`projector_simple.py`) - 当前使用

**原理：**
- 加载书架照片
- 根据坐标计算书籍位置
- 生成高亮图片（白色高亮 + 其他区域变暗）
- 保存图片文件，自动打开

**优点：**
- 不依赖GUI库，更可靠
- 可以用任何图片查看器全屏显示
- 适合投影仪使用

#### 3.2 GUI模式（备选）

- **Tkinter模式** (`projector_tkinter.py`)：使用Tkinter创建全屏窗口
- **OpenCV模式** (`projector_image.py`)：使用OpenCV显示（在某些环境下可能失败）

## 工作流程

### 完整流程：

```
1. 用户说出书名
   ↓
2. 语音识别转换为文本
   ↓
3. 文本清理（移除干扰词）
   ↓
4. 在数据库中搜索匹配的书籍
   ↓
5. 获取书籍的归一化坐标（中心点 + 尺寸）
   ↓
6. 将中心点坐标转换为左上角像素坐标
   ↓
7. 在照片上绘制白色高亮框（只高亮文字区域）
   ↓
8. 变暗其他区域（80%透明度）
   ↓
9. 保存高亮图片
   ↓
10. 自动打开图片查看器
```

## 坐标系统

### 归一化坐标 (0-1)

- **x, y**: 书籍**中心点**在图片中的位置（0-1）
  - x=0 表示最左边，x=1 表示最右边
  - y=0 表示最上边，y=1 表示最下边
- **width, height**: 书籍的宽度和高度（0-1）
  - 表示占图片的百分比

### 坐标转换

**重要：** 归一化坐标存储的是**中心点**，但绘制时需要**左上角**坐标

```
归一化坐标 (center_x, center_y, width, height) → 像素坐标

1. 计算中心点像素坐标：
   center_x_pixel = center_x * 图片宽度
   center_y_pixel = center_y * 图片高度
   width_pixel = width * 图片宽度
   height_pixel = height * 图片高度

2. 计算左上角坐标（用于绘制）：
   左上角x = center_x_pixel - width_pixel / 2
   左上角y = center_y_pixel - height_pixel / 2
```

## 高亮显示原理

### 简单模式（当前使用）：

1. **加载原图**：读取书架照片
2. **计算高亮区域**：
   - 根据坐标计算书籍位置
   - 缩小到65%（只显示文字区域）
   - 稍微偏上（文字通常在书籍上部）
3. **生成效果**：
   - 其他区域：变暗（20%亮度）
   - 高亮区域：白色高亮（70%白色 + 30%原图）
   - 白色边框：6像素粗
4. **保存图片**：保存到 `projector_output/highlight.jpg`
5. **自动打开**：使用系统默认图片查看器

## 关键技术点

### 1. 坐标系统
- 使用归一化坐标（0-1），适配不同分辨率的图片
- 坐标表示中心点，不是左上角

### 2. 搜索匹配
- 多级匹配策略：精确 → 关键词 → 模糊
- 过滤干扰词，提高准确性
- 至少2个词匹配，避免误匹配

### 3. 显示优化
- 只高亮文字区域（65%大小）
- 其他区域变暗，突出高亮
- 白色高亮，在投影仪上更明显

### 4. 错误处理
- GUI失败时降级到文本输出
- 语音识别失败时显示错误信息
- 搜索失败时提示可用关键词

## 数据流

```
用户语音输入
    ↓
Google Speech API
    ↓
文本："lean impact"
    ↓
搜索算法
    ↓
匹配："lean impact" → 数据库中的 "lean impact"
    ↓
获取坐标：(0.46, 0.25, 0.12, 0.12)  # (center_x, center_y, width, height)
    ↓
转换为像素：
   中心点: (1970, 1428)  # 0.46*4284, 0.25*5712
   尺寸: (514, 686)      # 0.12*4284, 0.12*5712
   左上角: (1713, 1085)  # 1970-514/2, 1428-686/2
    ↓
缩小到文字区域：(约65%)
    ↓
生成高亮图片
    ↓
保存并打开
```

## 优势

1. **简单可靠**：不依赖复杂的GUI库
2. **灵活适配**：归一化坐标适配不同图片
3. **精确匹配**：改进的搜索算法减少误匹配
4. **易于校准**：提供可视化校准工具
5. **投影友好**：白色高亮在投影仪上清晰可见

## 扩展可能

- 使用OCR自动识别书籍位置
- 支持多语言语音识别
- 添加书籍信息查询功能
- 支持摄像头实时识别

