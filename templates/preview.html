<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËØ≠Èü≥‰π¶Á±çÊêúÁ¥¢È¢ÑËßà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .gif-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            position: relative;
        }

        #gifDisplay {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .status-bar {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .status-info {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
        }

        .status-info .status {
            color: #4caf50;
            font-weight: bold;
        }

        .status-info .status.listening {
            color: #f44336;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .voice-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .voice-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: #2196f3;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }

        .voice-btn:hover {
            background: #1976d2;
            transform: scale(1.1);
        }

        .voice-btn.listening {
            background: #f44336;
            animation: pulse 1s infinite;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.6);
        }

        .voice-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .recognized-text {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            max-width: 600px;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recognized-text.empty {
            color: #888;
        }

        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(244, 67, 54, 0.9);
            padding: 20px 40px;
            border-radius: 8px;
            font-size: 18px;
            z-index: 200;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .book-found {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(76, 175, 80, 0.9);
            padding: 20px 40px;
            border-radius: 8px;
            font-size: 18px;
            z-index: 200;
            display: none;
            text-align: center;
        }

        .book-found.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="status-bar">
        <div class="status-info">
            <span>Áä∂ÊÄÅ: </span>
            <span class="status" id="status">Â∞±Áª™</span>
        </div>
        <div class="status-info">
            <span>ËØÜÂà´Âà∞: </span>
            <span id="recognizedText" class="recognized-text empty">Á≠âÂæÖËØ≠Èü≥ËæìÂÖ•...</span>
        </div>
    </div>

    <div class="gif-container">
        <img id="gifDisplay" src="" alt="‰π¶Á±çÈ´ò‰∫ÆÂä®Áîª" style="display: none;">
    </div>

    <div class="voice-controls">
        <button id="voiceBtn" class="voice-btn" title="ÁÇπÂáªÂºÄÂßãËØ≠Èü≥ËØÜÂà´">
            üé§
        </button>
        <div id="recognizedTextBottom" class="recognized-text empty">ÁÇπÂáªÈ∫¶ÂÖãÈ£éÊåâÈíÆÂºÄÂßãËØ≠Èü≥ÊêúÁ¥¢</div>
    </div>

    <div class="error-message" id="errorMessage"></div>
    <div class="book-found" id="bookFound"></div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let recognition = null;
        let isListening = false;
        let currentGifUrl = null;

        // Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅËØ≠Èü≥ËØÜÂà´
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US'; // ‰ΩøÁî®Ëã±ÊñáÔºåÂõ†‰∏∫‰π¶Á±çÂêçÁß∞ÊòØËã±Êñá
            recognition.continuous = false; // ‰∏çËøûÁª≠ËØÜÂà´
            recognition.interimResults = false; // ‰∏çÊòæÁ§∫‰∏≠Èó¥ÁªìÊûú

            recognition.onstart = () => {
                isListening = true;
                updateUI();
                console.log('ËØ≠Èü≥ËØÜÂà´Â∑≤ÂºÄÂßã');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                console.log('ËØÜÂà´ÁªìÊûú:', transcript);
                document.getElementById('recognizedText').textContent = transcript;
                document.getElementById('recognizedText').classList.remove('empty');
                document.getElementById('recognizedTextBottom').textContent = transcript;
                document.getElementById('recognizedTextBottom').classList.remove('empty');
                
                // ÊêúÁ¥¢‰π¶Á±ç
                searchBook(transcript);
            };

            recognition.onerror = (event) => {
                console.error('ËØ≠Èü≥ËØÜÂà´ÈîôËØØ:', event.error);
                isListening = false;
                updateUI();
                
                let errorMsg = 'ËØ≠Èü≥ËØÜÂà´ÈîôËØØ';
                if (event.error === 'no-speech') {
                    errorMsg = 'Êú™Ê£ÄÊµãÂà∞ËØ≠Èü≥ÔºåËØ∑ÈáçËØï';
                } else if (event.error === 'network') {
                    errorMsg = 'ÁΩëÁªúÈîôËØØÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
                } else if (event.error === 'not-allowed') {
                    errorMsg = 'È∫¶ÂÖãÈ£éÊùÉÈôêË¢´ÊãíÁªùÔºåËØ∑ÂÖÅËÆ∏È∫¶ÂÖãÈ£éËÆøÈóÆ';
                }
                
                showError(errorMsg);
            };

            recognition.onend = () => {
                isListening = false;
                updateUI();
                console.log('ËØ≠Èü≥ËØÜÂà´Â∑≤ÁªìÊùü');
            };
        } else {
            console.error('ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´');
            document.getElementById('voiceBtn').disabled = true;
            showError('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´ÂäüËÉΩÔºåËØ∑‰ΩøÁî® Chrome Êàñ Edge ÊµèËßàÂô®');
        }

        // Êõ¥Êñ∞UIÁä∂ÊÄÅ
        function updateUI() {
            const btn = document.getElementById('voiceBtn');
            const status = document.getElementById('status');
            
            if (isListening) {
                btn.classList.add('listening');
                btn.textContent = 'üî¥';
                status.textContent = 'Ê≠£Âú®ÁõëÂê¨...';
                status.classList.add('listening');
            } else {
                btn.classList.remove('listening');
                btn.textContent = 'üé§';
                status.textContent = 'Â∞±Áª™';
                status.classList.remove('listening');
            }
        }

        // ËØ≠Èü≥ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        document.getElementById('voiceBtn').addEventListener('click', () => {
            if (!recognition) {
                showError('ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´');
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                // Ê∏ÖÈô§‰πãÂâçÁöÑËØÜÂà´ÁªìÊûú
                document.getElementById('recognizedText').textContent = 'Á≠âÂæÖËØ≠Èü≥ËæìÂÖ•...';
                document.getElementById('recognizedText').classList.add('empty');
                document.getElementById('recognizedTextBottom').textContent = 'Ê≠£Âú®ÁõëÂê¨...';
                document.getElementById('recognizedTextBottom').classList.remove('empty');
                
                try {
                    recognition.start();
                } catch (e) {
                    console.error('ÂêØÂä®ËØ≠Èü≥ËØÜÂà´Â§±Ë¥•:', e);
                    showError('Êó†Ê≥ïÂêØÂä®ËØ≠Èü≥ËØÜÂà´ÔºåËØ∑ÈáçËØï');
                }
            }
        });

        // ÊêúÁ¥¢‰π¶Á±ç
        async function searchBook(query) {
            try {
                document.getElementById('status').textContent = 'Ê≠£Âú®ÊêúÁ¥¢...';
                
                // Ë∞ÉÁî®ÂêéÁ´ØAPIÊêúÁ¥¢‰π¶Á±ç
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query
                    })
                });

                const result = await response.json();

                if (result.success && result.book_key) {
                    // ÊâæÂà∞‰π¶Á±çÔºåÁîüÊàêÂπ∂ÊòæÁ§∫GIF
                    showBookFound(result.book_name);
                    
                    // ËØ≠Èü≥ÂèçÈ¶àÔºöÊâæÂà∞‰π¶Á±ç
                    speak(`Found book: ${result.book_name}`);
                    
                    await generateAndShowGif(result.book_key);
                } else {
                    // Êú™ÊâæÂà∞‰π¶Á±ç
                    showError('Êú™ÊâæÂà∞ÂåπÈÖçÁöÑ‰π¶Á±ç: ' + query);
                    
                    // ËØ≠Èü≥ÂèçÈ¶àÔºöÊú™ÊâæÂà∞
                    speak('Sorry, book not found');
                    
                    hideGif();
                }
            } catch (error) {
                console.error('ÊêúÁ¥¢Â§±Ë¥•:', error);
                showError('ÊêúÁ¥¢Â§±Ë¥•: ' + error.message);
                hideGif();
            } finally {
                document.getElementById('status').textContent = 'Â∞±Áª™';
            }
        }

        // ÁîüÊàêÂπ∂ÊòæÁ§∫GIF
        async function generateAndShowGif(bookKey) {
            try {
                document.getElementById('status').textContent = 'Ê≠£Âú®ÁîüÊàêÂä®Áîª...';
                
                const response = await fetch('/api/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        book_key: bookKey,
                        image_path: 'bookshelf.jpg'
                    })
                });

                if (!response.ok) {
                    throw new Error('ÁîüÊàêÈ¢ÑËßàÂ§±Ë¥•');
                }

                const result = await response.json();
                
                // ÊòæÁ§∫GIF
                const gifDisplay = document.getElementById('gifDisplay');
                const gifUrl = result.preview_url;
                
                // Â¶ÇÊûúÊòØHTMLÊñá‰ª∂ÔºåÊèêÂèñGIFË∑ØÂæÑ
                if (gifUrl.endsWith('.html')) {
                    // HTMLÊñá‰ª∂Ë∑ØÂæÑÔºåÈúÄË¶ÅÊèêÂèñGIFÊñá‰ª∂Âêç
                    const gifPath = gifUrl.replace('.html', '.gif');
                    gifDisplay.src = gifPath;
                } else {
                    gifDisplay.src = gifUrl;
                }
                
                gifDisplay.style.display = 'block';
                currentGifUrl = gifUrl;
                
                console.log('GIFÂ∑≤ÊòæÁ§∫:', gifUrl);
            } catch (error) {
                console.error('ÁîüÊàêGIFÂ§±Ë¥•:', error);
                showError('ÁîüÊàêÂä®ÁîªÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÈöêËóèGIF
        function hideGif() {
            const gifDisplay = document.getElementById('gifDisplay');
            gifDisplay.style.display = 'none';
            gifDisplay.src = '';
            currentGifUrl = null;
        }

        // ËØ≠Èü≥ÂèçÈ¶àÂáΩÊï∞
        function speak(text) {
            if ('speechSynthesis' in window) {
                // ÂÅúÊ≠¢‰πãÂâçÁöÑËØ≠Èü≥
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US'; // ‰ΩøÁî®Ëã±Êñá
                utterance.rate = 1.0; // ËØ≠ÈÄü
                utterance.pitch = 1.0; // Èü≥Ë∞É
                utterance.volume = 1.0; // Èü≥Èáè
                
                window.speechSynthesis.speak(utterance);
            }
        }
        
        // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 3000);
        }

        // ÊòæÁ§∫ÊâæÂà∞‰π¶Á±çÁöÑÊ∂àÊÅØ
        function showBookFound(bookName) {
            const foundDiv = document.getElementById('bookFound');
            foundDiv.textContent = `ÊâæÂà∞‰π¶Á±ç: ${bookName}`;
            foundDiv.classList.add('show');
            
            setTimeout(() => {
                foundDiv.classList.remove('show');
            }, 2000);
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁöÑÂàùÂßãÂåñ
        window.addEventListener('load', () => {
            console.log('È¢ÑËßàÈ°µÈù¢Â∑≤Âä†ËΩΩ');
            document.getElementById('status').textContent = 'Â∞±Áª™';
        });
    </script>
</body>
</html>

